<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>naryn • naryn</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="naryn">
<meta property="og:description" content="naryn">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">naryn</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.6.15</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/naryn.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/advanced.html">advanced naryn</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tanaylab/naryn/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="naryn_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>naryn</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tanaylab/naryn/blob/HEAD/vignettes/articles/naryn.Rmd" class="external-link"><code>vignettes/articles/naryn.Rmd</code></a></small>
      <div class="hidden name"><code>naryn.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tanaylab.github.io/naryn" class="external-link">naryn</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'naryn'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     months</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="getting-started-with-naryn">Getting started with naryn<a class="anchor" aria-label="anchor" href="#getting-started-with-naryn"></a>
</h2>
<p>Naryn is an implementation of a time-series database, for efficient storage, retrieval and analysis of electronic health records (EHR).</p>
<div class="section level4">
<h4 id="download-the-example-database">Download the example database<a class="anchor" aria-label="anchor" href="#download-the-example-database"></a>
</h4>
<p>Towards this vignette we are going to use a small database which was simulated to include an example of a typical EMR database. It can be downloaded from <a href="https://naryn.s3.eu-west-1.amazonaws.com/naryn_example_db.tar.gz" class="external-link">here</a> or using the following code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_download_example_data.html">emr_download_example_data</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Note that although smaller than the real database, this example database is still quite large (~1.2GB) and will take a few minutes to download.</p>
</div>
<div class="section level3">
<h3 id="tracks">Tracks<a class="anchor" aria-label="anchor" href="#tracks"></a>
</h3>
<p>The basic element of Naryn is a track - a single numerical data element (e.g. RBC lab test result) that is recorded for many patients at various time points. A track can be thought of as a very sparse two-dimensional matrix with a row for each patient in the database, and a column for each timepoint in the resolution of hours. Another way to think of a track is as a table with triplets of patient, timepoint and value:</p>
<table class="table">
<thead><tr class="header">
<th align="right">id</th>
<th align="right">time</th>
<th align="right">lab.RBC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1218708</td>
<td align="right">4.784053</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1223571</td>
<td align="right">4.534783</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">1227064</td>
<td align="right">4.114022</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1230857</td>
<td align="right">4.588766</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">1272632</td>
<td align="right">4.507858</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">1218461</td>
<td align="right">4.620333</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">1242600</td>
<td align="right">5.412831</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">1246149</td>
<td align="right">5.555339</td>
</tr>
</tbody>
</table>
<p>The value can be any numerical value, but it is usually a lab test result, or categorical variable representing a diagnosis. The time is a number representing the number of hours since 1/3/1867 00:00, and the id is a unique identifier for each patient which is defined in a special track called ‘<em>patients.dob</em>’, which contains the time of birth for each patient (see below).</p>
<p>For more information on tracks, see the ‘Tracks’ section in the <a href="advanced.html">advanced vignette</a>.</p>
</div>
<div class="section level3">
<h3 id="connect-to-database">Connect to database<a class="anchor" aria-label="anchor" href="#connect-to-database"></a>
</h3>
<p>A naryn database is a folder containing a number of tracks. To connect to a database, use the <code>emr_db.connect</code> function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_db.connect.html">emr_db.connect</a></span><span class="op">(</span><span class="st">"sample_db"</span><span class="op">)</span></span></code></pre></div>
<p>Now we can use <code>emr_track.ls</code> to list all the tracks in the database:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/emr_track.ls.html">emr_track.ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "dx.icd9_000" "dx.icd9_001" "dx.icd9_002" "dx.icd9_003" "dx.icd9_004"</span></span>
<span><span class="co">#&gt; [6] "dx.icd9_005"</span></span>
<span></span>
<span><span class="co"># show number of available tracks in database</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/emr_track.ls.html">emr_track.ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2995</span></span></code></pre></div>
<p>We can also use <code>emr_track.ls</code> to list all the tracks that match a certain pattern:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_track.ls.html">emr_track.ls</a></span><span class="op">(</span><span class="st">"RBC"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "lab.RBC"      "lab.RBC.URIN"</span></span></code></pre></div>
<blockquote>
<p>Note: Naryn supports connecting to multiple databases at the same time, by giving a vector of paths to <code>emr_db.connect</code>, see more in the ‘Database’ section of the <a href="advanced.html">advanced vignette</a>.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="extract-data-from-tracks">Extract data from tracks<a class="anchor" aria-label="anchor" href="#extract-data-from-tracks"></a>
</h3>
<p>We can now go back to the ‘RBC’ example and extract the data from the track. This can be done using the <code><a href="../reference/emr_extract.html">emr_extract()</a></code> function which is the ‘Swiss army knife’ of the package. It can be used to extract data from a single track, or from multiple tracks, while applying various filters and transformations, but we will start with the simplest example of extracting the data from a single track:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rbc_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"lab.RBC"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">rbc_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref  lab.RBC</span></span>
<span><span class="co">#&gt; 1  1 1218708  -1 4.784053</span></span>
<span><span class="co">#&gt; 2  1 1223571  -1 4.534783</span></span>
<span><span class="co">#&gt; 3  1 1227064  -1 4.114022</span></span>
<span><span class="co">#&gt; 4  1 1227864  -1 4.002392</span></span>
<span><span class="co">#&gt; 5  1 1232022  -1 4.384029</span></span>
<span><span class="co">#&gt; 6  1 1234887  -1 5.053118</span></span></code></pre></div>
<p>We can see that the data is returned as a data frame with four columns: id, time, ref and value. The id column contains the patient id, the time column contains the time of the measurement in hours since 1/3/1867 00:00, and the value column contains the Red Blood Cell count of the patient at each timepoint. For information regarding the ref column, see the ‘Records and References’ section in the <a href="advanced.html">advanced vignette</a>.</p>
<p>The data frame is sorted by id and time, so that the data for each patient is consecutive.</p>
<div class="section level4">
<h4 id="track-expression">Track expression<a class="anchor" aria-label="anchor" href="#track-expression"></a>
</h4>
<p>The first argument of <code>emr_extract</code> was, in the example above, a string representing the name of the track. However, it can also be a <em>track expression</em>, which is a string that can contain functions that will be applied to the track after extracting the data. For example, we can extract the lab value multiplied by two:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rbc_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"lab.RBC * 2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">rbc_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref lab.RBC * 2</span></span>
<span><span class="co">#&gt; 1  1 1218708  -1    9.568107</span></span>
<span><span class="co">#&gt; 2  1 1223571  -1    9.069567</span></span>
<span><span class="co">#&gt; 3  1 1227064  -1    8.228045</span></span>
<span><span class="co">#&gt; 4  1 1227864  -1    8.004785</span></span>
<span><span class="co">#&gt; 5  1 1232022  -1    8.768059</span></span>
<span><span class="co">#&gt; 6  1 1234887  -1   10.106236</span></span></code></pre></div>
<p>Note that the functions applied to the track in the track expression should be functions that can be applied to a vector of values, and should return a vector of the same length.</p>
<div class="section level5">
<h5 id="changing-time-to-date">Changing time to date<a class="anchor" aria-label="anchor" href="#changing-time-to-date"></a>
</h5>
<p>We can transform the time to year, month day and hour using the <code><a href="../reference/emr_time2date.html">emr_time2date()</a></code> function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rbc_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="../reference/emr_time2date.html">emr_time2date</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref lab.RBC * 2 year month day hour</span></span>
<span><span class="co">#&gt; 1  1 1218708  -1    9.568107 2006     3  11   12</span></span>
<span><span class="co">#&gt; 2  1 1223571  -1    9.069567 2006     9  30    3</span></span>
<span><span class="co">#&gt; 3  1 1227064  -1    8.228045 2007     2  22   16</span></span>
<span><span class="co">#&gt; 4  1 1227864  -1    8.004785 2007     3  28    0</span></span>
<span><span class="co">#&gt; 5  1 1232022  -1    8.768059 2007     9  17    6</span></span>
<span><span class="co">#&gt; 6  1 1234887  -1   10.106236 2008     1  14   15</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="iterators-and-virtual-tracks">Iterators and virtual tracks<a class="anchor" aria-label="anchor" href="#iterators-and-virtual-tracks"></a>
</h3>
<p>In the previous example we extracted the data from a single track, what happens if we want to extract data from multiple tracks at once? For example, we would want to extract the RBC and WBC (White Blood cell Count) of patients which had a heart disease (ICD9 code 411), 5 years before their diagnosis. In order to achieve this we need to introduce the concept of <em>iterators</em>.</p>
<p>An iterator is a set of points in the <em>patient-time space</em><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> that defines the way in which naryn traverses the database. In the RBC example, the iterator was simply the set of all <em>patient-time</em> points that were included in the track, but now - we would want our point-of-view to be the heart disease diagnosis so we would set the iterator to the track of ICD code 411:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">heart_blood</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lab.RBC"</span>, <span class="st">"lab.WBC"</span><span class="op">)</span>, iterator <span class="op">=</span> <span class="st">"dx.icd9_411"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">heart_blood</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref lab.RBC lab.WBC</span></span>
<span><span class="co">#&gt; 1  1 1220308  -1     NaN     NaN</span></span>
<span><span class="co">#&gt; 2  1 1220947  -1     NaN     NaN</span></span>
<span><span class="co">#&gt; 3  1 1241362  -1     NaN     NaN</span></span>
<span><span class="co">#&gt; 4  4 1280579  -1     NaN     NaN</span></span>
<span><span class="co">#&gt; 5  4 1329136  -1     NaN     NaN</span></span>
<span><span class="co">#&gt; 6  4 1335742  -1     NaN     NaN</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">heart_blood</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 19</span></span></code></pre></div>
<p>We can see that the “lab.RBC” and “lab.WBC” are all NA. This is because the iterator is set to the “dx.icd9_411” diagnosis, and the RBC and WBC tests were not performed at the exact time the diagnosis was recorded. In order to get the RBC test that was done 5 years prior to the diagnosis, we would have to:</p>
<ol style="list-style-type: decimal">
<li>Tell naryn to look back 5 years before the diagnosis</li>
<li>Tell naryn what to do if there is more than one RBC test in the 5 years prior to the diagnosis, for example - take the earliest, or more generally - tell naryn which function to apply to values of the track.</li>
</ol>
<p>This can be done using a <em>virtual track</em>. A virtual track is a way to tell naryn how to compute the value of a track when at a specific point in the <em>patient-time space</em>. It is created using the <code>emr_virtual_track()</code> function, which tells naryn how to shift the time for a given track (1, <code>time.shift</code>) and which function to apply to the values of the track (2, <code>func</code>). Note that the time shift is always in reference to the <em>iterator</em>. So for example, in our case we would like to look at an RBC / WBC measurement 5 years before the diagnosis. If our iterator is at the time of heart disease diagnosis, we want to look at a time window that starts 5 years before and ends at the time of diagnosis:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"rbc_5y"</span>, <span class="st">"lab.RBC"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"earliest"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"wbc_5y"</span>, <span class="st">"lab.WBC"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"earliest"</span><span class="op">)</span></span></code></pre></div>
<p>Now, we can extract the data from the virtual tracks (instead of the tracks themselves):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">heart_blood</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rbc_5y"</span>, <span class="st">"wbc_5y"</span><span class="op">)</span>, iterator <span class="op">=</span> <span class="st">"dx.icd9_411"</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RBC"</span>, <span class="st">"WBC"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">heart_blood</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref      RBC      WBC</span></span>
<span><span class="co">#&gt; 1  1 1220308  -1 4.784053 8.008108</span></span>
<span><span class="co">#&gt; 2  1 1220947  -1 4.784053 8.008108</span></span>
<span><span class="co">#&gt; 3  1 1241362  -1 4.784053 8.008108</span></span>
<span><span class="co">#&gt; 4  4 1280579  -1 4.617556 5.105508</span></span>
<span><span class="co">#&gt; 5  4 1329136  -1 4.421784 6.366830</span></span>
<span><span class="co">#&gt; 6  4 1335742  -1 4.619302 5.197200</span></span></code></pre></div>
<p>We would like to also know how long before the diagnosis each test was performed, so we will create an additional virtual track, this time with a function that computes the difference between the time of the diagnosis and the earliest blood test. Also, we would like the time difference to be in the resolution of months, so we will give <code>emr_extract</code> a track expression that divides the time difference by 30 * 24 (the number of hours in a month), which is equivalent to the <code>month</code> function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"rbc_5y_d"</span>, <span class="st">"lab.RBC"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"dt2.earliest"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"wbc_5y_d"</span>, <span class="st">"lab.WBC"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"dt2.earliest"</span><span class="op">)</span></span>
<span><span class="va">heart_blood</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rbc_5y"</span>, <span class="st">"wbc_5y"</span>, <span class="st">"rbc_5y_d/month()"</span>, <span class="st">"wbc_5y_d/month()"</span><span class="op">)</span>,</span>
<span>    iterator <span class="op">=</span> <span class="st">"dx.icd9_411"</span>,</span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RBC"</span>, <span class="st">"WBC"</span>, <span class="st">"RBC_d"</span>, <span class="st">"WBC_d"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">heart_blood</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref      RBC      WBC     RBC_d     WBC_d</span></span>
<span><span class="co">#&gt; 1  1 1220308  -1 4.784053 8.008108  2.222222  2.222222</span></span>
<span><span class="co">#&gt; 2  1 1220947  -1 4.784053 8.008108  3.109722  3.109722</span></span>
<span><span class="co">#&gt; 3  1 1241362  -1 4.784053 8.008108 31.463889 31.463889</span></span>
<span><span class="co">#&gt; 4  4 1280579  -1 4.617556 5.105508 57.434722 57.434722</span></span>
<span><span class="co">#&gt; 5  4 1329136  -1 4.421784 6.366830 59.809722 59.809722</span></span>
<span><span class="co">#&gt; 6  4 1335742  -1 4.619302 5.197200 52.718056 52.718056</span></span></code></pre></div>
<p>Yay! we got what we wanted, but something is still weird - we can see that some patients (and in this sampled database - most patients) have more than one diagnosis of a heart disease. Many times, this is indeed the case - a patient can be diagnosed with heart disease multiple times, but more commonly in EMR data - the same diagnosis is recorded multiple times, and what we actually want is the earliest diagnosis. In order to achieve that we would have to use <em>filters</em>.</p>
</div>
<div class="section level3">
<h3 id="filters">Filters<a class="anchor" aria-label="anchor" href="#filters"></a>
</h3>
<p>A <em>filter</em> is a logical condition that is applied to the <em>iterator</em> in order to decide which points to include and which to exclude. In our case we want to include only the earliest diagnosis of heart disease, so we would use the <code>emr_filter.create</code> function to create a filter that would exclude all points that had a diagnosis of heart disease prior to the current point:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"heart_disease_in_past"</span>, <span class="st">"dx.icd9_411"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will now apply the filter to our query:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">heart_blood</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rbc_5y"</span>, <span class="st">"wbc_5y"</span>, <span class="st">"rbc_5y_d/month()"</span>, <span class="st">"wbc_5y_d/month()"</span><span class="op">)</span>,</span>
<span>    iterator <span class="op">=</span> <span class="st">"dx.icd9_411"</span>,</span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RBC"</span>, <span class="st">"WBC"</span>, <span class="st">"RBC_d"</span>, <span class="st">"WBC_d"</span><span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="st">"!heart_disease_in_past"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">heart_blood</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref      RBC      WBC     RBC_d     WBC_d</span></span>
<span><span class="co">#&gt; 1  1 1220308  -1 4.784053 8.008108  2.222222  2.222222</span></span>
<span><span class="co">#&gt; 2  4 1280579  -1 4.617556 5.105508 57.434722 57.434722</span></span>
<span><span class="co">#&gt; 3  5 1306345  -1 6.196034 9.277723 57.438889 57.438889</span></span>
<span><span class="co">#&gt; 4  6 1259009  -1 4.271791 7.004467 43.415278 43.415278</span></span>
<span><span class="co">#&gt; 5 19 1322741  -1 4.385486 7.695645 53.869444 53.869444</span></span>
<span><span class="co">#&gt; 6 22 1227666  -1 3.858857 4.801625 13.520833 13.520833</span></span></code></pre></div>
<p>Voila! every patient now has only the earliest diagnosis of heart disease.</p>
<div class="section level4">
<h4 id="value-filters">Value filters<a class="anchor" aria-label="anchor" href="#value-filters"></a>
</h4>
<p>Filters can not only be used to exclude or include points by the mere existence of a point in the <em>patient-time space</em> (like the previous example), but also by the value of the point. For example, we can create a filter that would include only points where the RBC was abnormal (say, above 6):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"abnormal_rbc"</span>, <span class="st">"rbc_5y"</span>, val <span class="op">=</span> <span class="fl">6</span>, operator <span class="op">=</span> <span class="st">"&gt;"</span><span class="op">)</span></span>
<span><span class="va">heart_blood_abnormal_rbc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rbc_5y"</span>, <span class="st">"wbc_5y"</span><span class="op">)</span>,</span>
<span>    iterator <span class="op">=</span> <span class="st">"dx.icd9_411"</span>,</span>
<span>    filter <span class="op">=</span> <span class="st">"!heart_disease_in_past &amp; abnormal_rbc"</span>,</span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RBC"</span>, <span class="st">"WBC"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">heart_blood_abnormal_rbc</span><span class="op">)</span></span>
<span><span class="co">#&gt;     id    time ref      RBC       WBC</span></span>
<span><span class="co">#&gt; 1    5 1306345  -1 6.196034  9.277723</span></span>
<span><span class="co">#&gt; 2 2230 1320077  -1 7.511171  7.800000</span></span>
<span><span class="co">#&gt; 3 3312 1276025  -1 6.453111 11.903167</span></span>
<span><span class="co">#&gt; 4 3432 1332812  -1 6.169343  7.750395</span></span>
<span><span class="co">#&gt; 5 3529 1269751  -1 6.435419  8.229447</span></span>
<span><span class="co">#&gt; 6 4326 1234490  -1 6.006401  9.864933</span></span></code></pre></div>
<p>Another example is to include or exclude based on the value of a categorical track. For example, in order to include only patients that were diagnosed with Postmyocardial infarction syndrome (ICD9 code 411.0) we filter “dx.icd9_411” to include only points with value of “10” (see note below):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"postmyocardial_infarction"</span>, <span class="st">"dx.icd9_411"</span>, val <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">postmyo_blood</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rbc_5y"</span>, <span class="st">"wbc_5y"</span>, <span class="st">"dx.icd9_411"</span><span class="op">)</span>,</span>
<span>    iterator <span class="op">=</span> <span class="st">"dx.icd9_411"</span>,</span>
<span>    filter <span class="op">=</span> <span class="st">"!heart_disease_in_past &amp; postmyocardial_infarction"</span>,</span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RBC"</span>, <span class="st">"WBC"</span>, <span class="st">"icd9_411"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">postmyo_blood</span><span class="op">)</span></span>
<span><span class="co">#&gt;     id    time ref      RBC       WBC icd9_411</span></span>
<span><span class="co">#&gt; 1  252 1243750  -1 4.303543  5.099193       10</span></span>
<span><span class="co">#&gt; 2 1537 1277787  -1 4.400787  5.095808       10</span></span>
<span><span class="co">#&gt; 3 3226 1280679  -1 4.061680  4.804326       10</span></span>
<span><span class="co">#&gt; 4 3320 1349528  -1 4.672515  5.503540       10</span></span>
<span><span class="co">#&gt; 5 3407 1263521  -1 5.311868 10.404092       10</span></span>
<span><span class="co">#&gt; 6 3529 1269751  -1 6.435419  8.229447       10</span></span></code></pre></div>
<blockquote>
<p>NOTE: since ICD9 diagnosis codes have a tree like structure, and X.0, X.00 are both valid codes and must be distinguishable, the diagnosis tracks all include a prefix of 1 for the minor code, so X.0 will be translated to icd9_X and a value of 10 will be stored instead of 0.</p>
</blockquote>
</div>
</div>
<div class="section level3">
<h3 id="extract-all-patients-in-database">Extract all patients in database<a class="anchor" aria-label="anchor" href="#extract-all-patients-in-database"></a>
</h3>
<p>As noted above, all patients must be listed in a track called ‘patients.dob’. This track contains for each patient a single time point at the time of birth. In this mock database, the value per patient reflect their sex: 1 for male, 2 for female:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">patients</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"patients.dob"</span>, names <span class="op">=</span> <span class="st">"sex"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">patients</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref sex</span></span>
<span><span class="co">#&gt; 1  1  535998  -1   1</span></span>
<span><span class="co">#&gt; 2  2 1024040  -1   2</span></span>
<span><span class="co">#&gt; 3  3  807917  -1   1</span></span>
<span><span class="co">#&gt; 4  4  864871  -1   1</span></span>
<span><span class="co">#&gt; 5  5  826123  -1   1</span></span>
<span><span class="co">#&gt; 6  6  817547  -1   2</span></span>
<span><span class="va">patients</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">[</span><span class="va">sex</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;      sex     n</span></span>
<span><span class="co">#&gt; 1   male 48621</span></span>
<span><span class="co">#&gt; 2 female 51379</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-virtual-tracks-for-age-and-sex">Define virtual tracks for age and sex<a class="anchor" aria-label="anchor" href="#define-virtual-tracks-for-age-and-sex"></a>
</h3>
<p>Given what we learned about iterators, virtual tracks and filters, how would we extract the <em>age</em> of a patient at a given timepoint? For example, say that we want to know the age of a patient at the time of their first diagnosis of heart disease. We can do this by creating a virtual track that computes the difference between the time of the diagnosis and the time of birth.</p>
<p>A virtual track needs 4 things - name, source, time shift and function. We should set the name to “age”, the source to “patients.dob” and at each point of the iterator we would like to go backward in time a maximal amount (say - 120 years) and compute the time difference between the point and the birth, so we will set the <code>time.shift</code> to <code>c(-years(120), 0)</code> and the function to <code>dt2.earliest</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"patients.dob"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"dt2.earliest"</span><span class="op">)</span></span></code></pre></div>
<p>We can now extract the age of the patient at the time of their first diagnosis of heart disease in the resolution of years:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_at_heart_diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"age/year()"</span>, iterator <span class="op">=</span> <span class="st">"dx.icd9_411"</span>, name <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">age_at_heart_diag</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref      age</span></span>
<span><span class="co">#&gt; 1  1 1220308  -1 78.11758</span></span>
<span><span class="co">#&gt; 2  1 1220947  -1 78.19053</span></span>
<span><span class="co">#&gt; 3  1 1241362  -1 80.52100</span></span>
<span><span class="co">#&gt; 4  4 1280579  -1 47.45525</span></span>
<span><span class="co">#&gt; 5  4 1329136  -1 52.99829</span></span>
<span><span class="co">#&gt; 6  4 1335742  -1 53.75240</span></span></code></pre></div>
<p>Sex can be defined in a similar way going backward in time and taking the earliest value at the “patients.dob” track:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"sex"</span>, <span class="st">"patients.dob"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"earliest"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-a-virtual-track-for-survival---time-until-death">Define a virtual track for survival - time until death<a class="anchor" aria-label="anchor" href="#define-a-virtual-track-for-survival---time-until-death"></a>
</h3>
<p>Assume that <code>patients.dod</code> is a track with a single entry (at most) for each patient in the EHR database at time of death. Define a virtual track that computes the time until death for each patient in the current iterator timepoint:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"survival"</span>, <span class="st">"patients.dod"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">120</span> <span class="op">*</span> <span class="fl">365</span> <span class="op">*</span> <span class="fl">24</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"dt1.earliest"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="time-range">Time range<a class="anchor" aria-label="anchor" href="#time-range"></a>
</h3>
<p>Until now we learned how to use filters to exclude or include datapoints by their value or existence, but what if we want to include only points that are within a certain time range? For example, say that we want to extract the age and WBC test values of tests that were performed in 2010. We can do this by using the <code>stime</code> and <code>etime</code> arguments of <code>emr_extract</code> which limit the query to points that are between the given start and end times:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wbc_2010</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age/year()"</span>, <span class="st">"lab.WBC"</span><span class="op">)</span>, iterator <span class="op">=</span> <span class="st">"lab.WBC"</span>, stime <span class="op">=</span> <span class="fu"><a href="../reference/emr_date2time.html">emr_date2time</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2010</span><span class="op">)</span>, etime <span class="op">=</span> <span class="fu"><a href="../reference/emr_date2time.html">emr_date2time</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2011</span><span class="op">)</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"wbc"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">wbc_2010</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id    time ref      age       wbc</span></span>
<span><span class="co">#&gt; 1  1 1252814  -1 81.82831  8.058747</span></span>
<span><span class="co">#&gt; 2  1 1253515  -1 81.90833  7.199924</span></span>
<span><span class="co">#&gt; 3  3 1257273  -1 51.29635  6.600398</span></span>
<span><span class="co">#&gt; 4  4 1253349  -1 44.34680  8.300706</span></span>
<span><span class="co">#&gt; 5  4 1254029  -1 44.42443  7.102493</span></span>
<span><span class="co">#&gt; 6  4 1256304  -1 44.68413 11.600000</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="computing-distributions">Computing distributions<a class="anchor" aria-label="anchor" href="#computing-distributions"></a>
</h3>
<p><code>emr_extract</code> is not the only function that can be used to extract data from the database. Another function that can be used to extract data is <code>emr_dist</code>, which is used to compute distributions of values of a track. For example, say that we want to compute the distribution of Hemoglobin (HGB) values in the database, stratified by age and sex. One way to do it would be to extract the values of HGB, age and sex, and then compute the distribution using standard R functions. However, this would require loading the entire track into memory, which is not always possible, and moreover - it is less efficient to go over the same data twice. <code>emr_dist</code> can to it in one shot, by accepting pairs of tracks expression and breaks and counting the number of values in each strata:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hgb_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_dist.html">emr_dist</a></span><span class="op">(</span></span>
<span>    <span class="st">"age/year()"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">50</span>, <span class="fl">90</span><span class="op">)</span>,</span>
<span>    <span class="st">"sex"</span>, <span class="cn">NULL</span>,</span>
<span>    <span class="st">"lab.HGB"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">16</span>, by <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    iterator <span class="op">=</span> <span class="st">"lab.HGB"</span>,</span>
<span>    dataframe <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"hgb"</span><span class="op">)</span>,</span>
<span>    right <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">hgb_dist</span><span class="op">)</span></span>
<span><span class="co">#&gt;       age sex       hgb    n</span></span>
<span><span class="co">#&gt; 1 [20,50)   1 [10,10.5)  266</span></span>
<span><span class="co">#&gt; 2 [50,90)   1 [10,10.5) 2948</span></span>
<span><span class="co">#&gt; 3 [20,50)   2 [10,10.5) 6930</span></span>
<span><span class="co">#&gt; 4 [50,90)   2 [10,10.5) 8402</span></span>
<span><span class="co">#&gt; 5 [20,50)   1 [10.5,11)  344</span></span>
<span><span class="co">#&gt; 6 [50,90)   1 [10.5,11) 4355</span></span></code></pre></div>
<p>Note that for the categorical track “sex” the breaks were set to NULL which implicitly uses all the possible values in the track.</p>
<p>We can now plot the distributions:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hgb_dist</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">[</span><span class="va">sex</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">sex</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>p <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">hgb</span>, y <span class="op">=</span> <span class="va">p</span>, colour <span class="op">=</span> <span class="va">age</span>, group <span class="op">=</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"darkred"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sex</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Fraction of tests"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"HGB"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="naryn_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="additional-examples">Additional examples<a class="anchor" aria-label="anchor" href="#additional-examples"></a>
</h3>
<p>In the next few sections we will present a few additional examples of how to use <code>naryn</code> for analysis of EMR data. It is recommended to try and implement a solution to each example before looking at the code below it.</p>
<div class="section level4">
<h4 id="extract-survival-time-for-patients-with-pancreatic-cancer">Extract survival time for patients with pancreatic cancer<a class="anchor" aria-label="anchor" href="#extract-survival-time-for-patients-with-pancreatic-cancer"></a>
</h4>
<p>Extract the survival time (time until death) for patients with pancreatic cancer (ICD9 code 157.9):</p>
<p>Define a filter for just Pancreatic cancer in the 157 icd9 code:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"pancreatic_cancer"</span>, <span class="st">"dx.icd9_157"</span>, val <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span></code></pre></div>
<p>Define a filter for previous pancreatic cancer (sometime in the past):</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"pancreatic_cancer_in_past"</span>, <span class="st">"dx.icd9_157"</span>, val <span class="op">=</span> <span class="fl">19</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To find the first diagnosis of pancreatic cancer we will go over all 157 diagnosis, filter out those that are not pancreatic cancer and make sure there wasn’t a prior diagnosis of pancreatic cancer:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreatic_cancer_survival</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"survival"</span>, iterator <span class="op">=</span> <span class="st">"dx.icd9_157"</span>, filter <span class="op">=</span> <span class="st">"pancreatic_cancer &amp; !pancreatic_cancer_in_past"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pancreatic_cancer_survival</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 25</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pancreatic_cancer_survival</span><span class="op">)</span></span>
<span><span class="co">#&gt;      id    time ref survival</span></span>
<span><span class="co">#&gt; 1 12192 1256866  -1    19910</span></span>
<span><span class="co">#&gt; 2 17022 1311645  -1      NaN</span></span>
<span><span class="co">#&gt; 3 24217 1309964  -1    14332</span></span>
<span><span class="co">#&gt; 4 27971 1280769  -1     3927</span></span>
<span><span class="co">#&gt; 5 28135 1263030  -1    23106</span></span>
<span><span class="co">#&gt; 6 34252 1341200  -1     9016</span></span></code></pre></div>
<p>Note that NA in survival means that the patient still has not died.</p>
<p>We can now compute the Kaplan-Meier survival curve for pancreatic cancer patients. Censoring is applied to reflect latest update of database (Jan 6, 2022):</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreatic_cancer_survival</span> <span class="op">&lt;-</span> <span class="va">pancreatic_cancer_survival</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        follow_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">survival</span><span class="op">)</span>, <span class="va">survival</span>, <span class="fu"><a href="../reference/emr_date2time.html">emr_date2time</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">2022</span><span class="op">)</span> <span class="op">-</span> <span class="va">time</span><span class="op">)</span>,</span>
<span>        status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">survival</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>follow_time <span class="op">=</span> <span class="va">follow_time</span> <span class="op">/</span> <span class="fu"><a href="../reference/emr_time.html">month</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Fit the survival curve:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html" class="external-link">survminer</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: ggpubr</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'survival'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:survminer':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     myeloma</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/surv_fit.html" class="external-link">surv_fit</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">follow_time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">pancreatic_cancer_survival</span><span class="op">)</span></span>
<span><span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html" class="external-link">ggsurvplot</a></span><span class="op">(</span><span class="va">fit</span>, data <span class="op">=</span> <span class="va">pancreatic_cancer_survival</span>, xlab <span class="op">=</span> <span class="st">"Time (months)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="naryn_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="extract-hgb-and-age-for-all-patients-between-the-ages-60-and-70">Extract HGB and age for all patients between the ages 60 and 70<a class="anchor" aria-label="anchor" href="#extract-hgb-and-age-for-all-patients-between-the-ages-60-and-70"></a>
</h4>
<p>Extract all Hemoglobin tests (HGB), age (in years) and sex for patients between the ages of 60 and 70:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"age_60_70"</span>, <span class="st">"patients.dob"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">70</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hgb_60_70</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age/year()"</span>, <span class="st">"lab.HGB"</span>, <span class="st">"sex"</span><span class="op">)</span>, iterator <span class="op">=</span> <span class="st">"lab.HGB"</span>, filter <span class="op">=</span> <span class="st">"age_60_70"</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"HGB"</span>, <span class="st">"sex"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can now plot the distribution:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hgb_60_70</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">[</span><span class="va">sex</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">HGB</span>, color <span class="op">=</span> <span class="va">sex</span>, group <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="naryn_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="extract-patients-age-at-time-of-diagnosis-of-heart-disease-that-did-not-have-diabetes-in-the-past">Extract patients age at time of diagnosis of heart disease that did not have diabetes in the past<a class="anchor" aria-label="anchor" href="#extract-patients-age-at-time-of-diagnosis-of-heart-disease-that-did-not-have-diabetes-in-the-past"></a>
</h4>
<p>Extract patients age at the time of their first diagnosis of heart disease (diagnosis.411) that did not have diabetes (diagnosis.250) in the past.</p>
<p>This is very similar to the example above, in which we used a filter to exclude patients that had a previous diagnosis of heart disease. We are now going to use a slightly different approach that would first extract a the patient-time points of the heart disease onset and then use an additional query with these points as the iterator to filter out the patients that had diabetes in the past. This approach is useful in cases where we want to use the onset for other purposes, and it is convenient to have it in a separate table.</p>
<p>What would be our iterator? We can iterate the heart disease diagnosis track, and in many cases this would be the right choice. However, sometimes this track can be quite large, for example if it is a very common lab test. In such cases we can iterate over the “patients.dob” track instead, while shifting the time forward by the maximum amount (e.g. 120 years):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Find onset of heart disease</span></span>
<span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"heart_onset"</span>, <span class="st">"dx.icd9_411"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"earliest.time"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"has_heart_disease"</span>, <span class="st">"dx.icd9_411"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Retreive the earliest time of heart disease for all patients in db that have a heart disease</span></span>
<span><span class="va">heart_onset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"heart_onset"</span>, iterator <span class="op">=</span> <span class="st">"patients.dob"</span>, filter <span class="op">=</span> <span class="st">"has_heart_disease"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">heart_onset</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id   time ref heart_onset</span></span>
<span><span class="co">#&gt; 1  1 535998  -1     1220308</span></span>
<span><span class="co">#&gt; 2  4 864871  -1     1280579</span></span>
<span><span class="co">#&gt; 3  5 826123  -1     1306345</span></span>
<span><span class="co">#&gt; 4  6 817547  -1     1259009</span></span>
<span><span class="co">#&gt; 5 19 734365  -1     1322741</span></span>
<span><span class="co">#&gt; 6 22 469544  -1     1227666</span></span></code></pre></div>
<p>Now we can use the data frame we created as an iterator:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filter patients that already have diabetes before heart disease</span></span>
<span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"has_diabetes"</span>, <span class="st">"dx.icd9_250"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">heart_onset_no_diabetes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"age/year()"</span>, iterator <span class="op">=</span> <span class="va">heart_onset</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, time <span class="op">=</span> <span class="va">heart_onset</span><span class="op">)</span>, filter <span class="op">=</span> <span class="st">"!has_diabetes"</span>, names <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">heart_onset</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 25596</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">heart_onset_no_diabetes</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5137</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">heart_onset_no_diabetes</span><span class="op">)</span></span>
<span><span class="co">#&gt;    id    time ref      age</span></span>
<span><span class="co">#&gt; 1   6 1259009  -1 50.39521</span></span>
<span><span class="co">#&gt; 2  31 1229936  -1 69.97317</span></span>
<span><span class="co">#&gt; 3  36 1236550  -1 42.01963</span></span>
<span><span class="co">#&gt; 4  66 1237208  -1 71.25753</span></span>
<span><span class="co">#&gt; 5 114 1320426  -1 68.11872</span></span>
<span><span class="co">#&gt; 6 132 1352258  -1 68.12420</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="extract-median-hemoglobin-for-all-males-between-ages-60-to-70">Extract median Hemoglobin for all males between ages 60 to 70<a class="anchor" aria-label="anchor" href="#extract-median-hemoglobin-for-all-males-between-ages-60-to-70"></a>
</h4>
<p>Extract for each male patient the median Hemoglobin value between ages 60 and 70.</p>
<p>Again we would use “patients.dob” as our iterator - this is very efficient as every patient would be examined only once, and define a virtual track with a time shift of 60 to 70 years with a function of median:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_vtrack.create.html">emr_vtrack.create</a></span><span class="op">(</span><span class="st">"median_hgb"</span>, <span class="st">"lab.HGB"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span>, <span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">70</span><span class="op">)</span><span class="op">)</span>, func <span class="op">=</span> <span class="st">"quantile"</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Define a filter for males only:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"is_male"</span>, <span class="st">"patients.dob"</span>, val <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Add another filter for having an HGB test in the relevant ages:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"has_hgb"</span>, <span class="st">"lab.HGB"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span>, <span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">70</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Extract median_hgb for males only:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">male_hgb_60_70_q50</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"median_hgb"</span>, iterator <span class="op">=</span> <span class="st">"patients.dob"</span>, filter <span class="op">=</span> <span class="st">"is_male &amp; has_hgb"</span><span class="op">)</span></span></code></pre></div>
<p>Compare with female median hgb:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">female_hgb_60_70_q50</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_extract.html">emr_extract</a></span><span class="op">(</span><span class="st">"median_hgb"</span>, iterator <span class="op">=</span> <span class="st">"patients.dob"</span>, filter <span class="op">=</span> <span class="st">"!is_male &amp; has_hgb"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">male_hgb_60_70_q50</span><span class="op">$</span><span class="va">median_hgb</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span>, main <span class="op">=</span> <span class="st">"median HGB in ages 60-70"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">female_hgb_60_70_q50</span><span class="op">$</span><span class="va">median_hgb</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="naryn_files/figure-html/unnamed-chunk-38-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="count-number-of-patients-by-age-that-were-in-the-system-in-january-2020">Count number of patients by age that were in the system in January 2020<a class="anchor" aria-label="anchor" href="#count-number-of-patients-by-age-that-were-in-the-system-in-january-2020"></a>
</h4>
<p>What does it mean to be “in the system”? Every EHR system would have its own definition of this, but in general - we want the patients that have already been born, have not died yet, have registered with the EHR system and haven’t left the system (for good) yet.</p>
<p>We will start by creating a set of filters that will define the above conditions:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"born"</span>, <span class="st">"patients.dob"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"dead"</span>, <span class="st">"patients.dod"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"registered"</span>, <span class="st">"patients.status.register"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/emr_filter.create.html">emr_filter.create</a></span><span class="op">(</span><span class="st">"left_for_good"</span>, <span class="st">"patients.status.lfg"</span>, time.shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/emr_time.html">years</a></span><span class="op">(</span><span class="fl">120</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can now use an iterator of a single point while applying all the filters to count the number of patients that were in the system in January 2020:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_dist_2020</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emr_dist.html">emr_dist</a></span><span class="op">(</span><span class="st">"age/year()"</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">120</span>, <span class="st">"sex"</span>, <span class="cn">NULL</span>,</span>
<span>    iterator <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    stime <span class="op">=</span> <span class="fu"><a href="../reference/emr_date2time.html">emr_date2time</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2020</span><span class="op">)</span>,</span>
<span>    etime <span class="op">=</span> <span class="fu"><a href="../reference/emr_date2time.html">emr_date2time</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2020</span><span class="op">)</span>,</span>
<span>    filter <span class="op">=</span> <span class="st">"born &amp; !dead &amp; registered &amp; !left_for_good"</span>,</span>
<span>    names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"sex"</span><span class="op">)</span>,</span>
<span>    dataframe <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    right <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">age_dist_2020</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       age sex   n</span></span>
<span><span class="co">#&gt; 1 [19,20)   1  38</span></span>
<span><span class="co">#&gt; 2 [20,21)   1 105</span></span>
<span><span class="co">#&gt; 3 [21,22)   1 176</span></span>
<span><span class="co">#&gt; 4 [22,23)   1 250</span></span>
<span><span class="co">#&gt; 5 [23,24)   1 370</span></span>
<span><span class="co">#&gt; 6 [24,25)   1 436</span></span></code></pre></div>
<p>We can plot the distribution:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_dist_2020</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">[</span><span class="va">sex</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">n</span>, colour <span class="op">=</span> <span class="va">sex</span>, fill <span class="op">=</span> <span class="va">sex</span>, group <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sex</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="naryn_files/figure-html/unnamed-chunk-41-1.png" width="700"></p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Actually, <em>patient-time-reference</em> space, but this is explained in the advanced vignette.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Misha Hoichman, Aviezer Lifshitz, Ben Gilat.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
