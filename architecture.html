<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Architecture • naryn</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Architecture"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">naryn</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.6.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="articles/naryn.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tanaylab/naryn/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Architecture</h1>
      <small class="dont-index">Source: <a href="https://github.com/tanaylab/naryn/blob/HEAD/architecture.md" class="external-link"><code>architecture.md</code></a></small>
    </div>


<div id="architecture" class="section level1">

<p>Lifecycle of an <code>emr_extract</code> call:</p>
<ul><li>Start at <code>NRExtract.cpp</code>.</li>
<li>Create <code>NRTrackExprScanner</code> object for computation.</li>
</ul><p><code>NRTrackExpressionScanner</code> (<code>scanner</code> for short) is a class that generates iterators, i.e. it has <code>begin</code>, <code><a href="https://rdrr.io/r/base/Control.html" class="external-link">next</a></code> and <code>isend</code> methods and is used in a simple loop of the form (the following is only pseudu code):</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="cf">for</span> (scanner.begin(parameters); !scanner.isend(); scanner.next()) {
    <span class="er"># get the values </span>
    values_output = scanner.real();
    points_output = scanner.point();
    
    <span class="er"># check that we did not exceed the maximal data size</span>
}</code></pre></div>
<blockquote>
<p>The parameters the scanner gets in the <code>begin</code> function are the one of the <code>emr_extract</code> call: expressions, stime, etime, iterator, keepref and filter.</p>
</blockquote>
<div class="section level3">
<h3 id="inside-the-scanner">Inside the scanner<a class="anchor" aria-label="anchor" href="#inside-the-scanner"></a></h3>
<div class="section level4">
<h4 id="the-begin-method">The <code>begin</code> method:<a class="anchor" aria-label="anchor" href="#the-begin-method"></a></h4>
<ul><li>Converts expressions to strings and <code>stime</code> and <code>etime</code> to <code>unsigned</code> and <code>keepref</code> to logical.</li>
<li>Runs the <code>check</code> method (see below) which creates the tracks, vtracks and iterator objects.</li>
<li>Creates R variables for the tracks and virtual tracks (<code>define_r_vars</code> in the scanner and <code>NRTrackExpressionVars</code>) and reserves <code>eval_buf_limit</code> for the results at <code>m_expr_itr_points</code> and <code>m_eval_doubles</code>.</li>
<li>“Determining evaluation buffer size”. Not sure exactly how this works yet.</li>
</ul></div>
<div class="section level4">
<h4 id="the-check-method">The <code>check</code> method:<a class="anchor" aria-label="anchor" href="#the-check-method"></a></h4>
<ol><li>checks the validity of the expressions.</li>
<li>Adds to <code>m_expr_vars</code> virtual tracks and tracks that are in them using <code>parse_exprs</code>.</li>
<li>Tracks are added by getting an <code>EMRTrack</code> object from <code>g_db</code> which is an <code>EMRDb</code> object.</li>
<li>Virtual tracks are added by parsing their parameters and getting the needed source track from <code>g_db</code>. In case of a dataframe an intermediate track is being created.</li>
<li>If the virtual track has a filter - an intermediate track is created which applies the filter to the source track.</li>
<li>creates the iterator (<code>create_expr_iterator</code>): If iterator argument is a number - the iterator pointer (<code>m_itr</code>) gets a new <code>EMRBeatIterator</code> and if it is a string - <code>EMRTrackIterator</code>.</li>
<li>Parse the expressions (using R) and put the result at <code>m_eval_exprs</code>
</li>
</ol></div>
<div class="section level4">
<h4 id="the-next-method">The <code>next</code> method:<a class="anchor" aria-label="anchor" href="#the-next-method"></a></h4>
<p>Calls (when no multitasking) <code>eval_next</code>:</p>
<ul><li>Asks the current iterator for the current point.</li>
<li>calls <code>set_vars</code> which is a method of <code>NRTrackExprVars</code> (m_expr_vars) which is given the <code>point</code> from the iterator and fetches the data using the variable data fetcher.</li>
<li>Evaluates the expression using R on the fetched data (which is now at the new R variable).</li>
<li>Ask the iterator for the next point (<code>m_itr.next()</code>)</li>
</ul><blockquote>
<p>The magic of finding the next point (and filtering) is inside the iterator!</p>
</blockquote>
</div>
</div>
</div>
<div class="section level1">
<h1 id="filter-on-vtrack-proposal">Filter on vtrack proposal<a class="anchor" aria-label="anchor" href="#filter-on-vtrack-proposal"></a></h1>
<p>We can parse the filters, and whenever the source is vtrack, collect the expression. Then, we can:</p>
<ol><li>Run all the collected expressions together with the <strong>query iterator</strong> (and it’s filters without the vtracks)</li>
<li>Create temporary tracks with the results.</li>
<li>Change the vtrack filters to existence of the tracks.</li>
<li>Run the original query.</li>
</ol><p>We should create a new type of filter that returns either always TRUE or FALSE. When parsing the filter expression tree we will replace every vtrack filter with an operator of “or” with FALSE and those with operator of “and” with TRUE. We will keep a vector of pointers to all those filters, and the vtrack names of all their sources. Then, we will scan the vtrack expressions where the vtrack filters are effectivly ignored. We will have a new data frame from which we will be able to create new filters which we will use to replace the ones with the “inert” TRUE or FALSE.</p>
<div class="section level2">
<h2 id="keepref-on-vtracks">Keepref on vtracks<a class="anchor" aria-label="anchor" href="#keepref-on-vtracks"></a></h2>
<p>line 122 on NRTrackExpressionVars:</p>
<p>iimanager-&gt;transform(point, iimanager-&gt;keepref ? point.timestamp.refcount() : EMRTimeStamp::NA_REFCOUNT);</p>
</div>
</div>


  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Misha Hoichman, Aviezer Lifshitz, Ben Gilat.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

    </footer></div>

  

  

  </body></html>

